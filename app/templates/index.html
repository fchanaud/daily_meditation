{% extends "base.html" %}

{% block content %}
<div class="mood-container">
    <h2 class="mb-4">How are you feeling today?</h2>
    <p class="mb-4">Select your mood to find a 10-minute meditation that matches how you feel:</p>
    
    <form id="mood-form" action="/generate-meditation" method="post">
        <div class="mood-grid">
            {% for mood in moods %}
            <div class="mood-card" data-mood="{{ mood }}">
                <div class="mood-icon">
                    {% if mood == "calm" %}
                    <i class="fas fa-water"></i>
                    {% elif mood == "focused" %}
                    <i class="fas fa-bullseye"></i>
                    {% elif mood == "relaxed" %}
                    <i class="fas fa-couch"></i>
                    {% elif mood == "energized" %}
                    <i class="fas fa-bolt"></i>
                    {% elif mood == "grateful" %}
                    <i class="fas fa-heart"></i>
                    {% elif mood == "happy" %}
                    <i class="fas fa-smile-beam"></i>
                    {% elif mood == "peaceful" %}
                    <i class="fas fa-dove"></i>
                    {% elif mood == "confident" %}
                    <i class="fas fa-crown"></i>
                    {% elif mood == "creative" %}
                    <i class="fas fa-palette"></i>
                    {% elif mood == "compassionate" %}
                    <i class="fas fa-hands-helping"></i>
                    {% else %}
                    <i class="fas fa-spa"></i>
                    {% endif %}
                </div>
                <h5>{{ mood|title }}</h5>
                <div class="form-check" style="display: none;">
                    <input class="form-check-input mood-radio" type="radio" name="mood" id="mood-{{ mood }}" value="{{ mood }}">
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="language-selection mt-5 mb-4">
            <h5>Choose your language:</h5>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="language" id="language-english" value="english" checked>
                <label class="form-check-label" for="language-english">English</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="language" id="language-french" value="french">
                <label class="form-check-label" for="language-french">French</label>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="find-meditation" disabled>
                Find My Meditation
            </button>
        </div>
    </form>
    
    <!-- Progress indicator -->
    <div id="progress-container" class="mt-4" style="display: none;">
        <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
        </div>
        <p id="progress-stage" class="text-center mt-2">Searching for the perfect meditation...</p>
    </div>
    
    <!-- Response container -->
    <div id="response-container" class="mt-4 text-center" style="display: none;">
        <div class="alert alert-info">
            <h4 id="response-title" class="alert-heading">Your meditation selection:</h4>
            <p id="response-message"></p>
            <hr>
            <p class="mb-0" id="response-note"></p>
        </div>
        
        <!-- Audio player -->
        <div id="audio-player-container" class="mt-4" style="display: none;">
            <button id="force-play-button" class="btn btn-lg btn-primary mb-3 w-100">
                <i class="fas fa-play"></i> Play Meditation
            </button>
            <audio id="meditation-audio" controls class="w-100">
                <source id="meditation-source" src="" type="audio/mpeg">
                <source id="meditation-source-mp4" src="" type="audio/mp4">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all mood cards
        const moodCards = document.querySelectorAll('.mood-card');
        const moodRadios = document.querySelectorAll('.mood-radio');
        const submitButton = document.getElementById('find-meditation');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStage = document.getElementById('progress-stage');
        const responseContainer = document.getElementById('response-container');
        const responseMessage = document.getElementById('response-message');
        const responseNote = document.getElementById('response-note');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const meditationAudio = document.getElementById('meditation-audio');
        const meditationSource = document.getElementById('meditation-source');
        
        // Add click event to mood cards
        moodCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                moodCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Check the radio button
                const moodValue = this.dataset.mood;
                const radio = document.getElementById('mood-' + moodValue);
                radio.checked = true;
                
                // Enable the submit button
                submitButton.disabled = false;
            });
        });
        
        // Form submission handler
        document.getElementById('mood-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get selected mood and language
            const selectedMood = document.querySelector('input[name="mood"]:checked').value;
            const selectedLanguage = document.querySelector('input[name="language"]:checked').value;
            
            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Reset progress bar
            progressBar.style.width = '0%';
            progressStage.textContent = 'Searching for the perfect meditation...';
            progressContainer.style.display = 'block';
            
            // Hide any previous response
            responseContainer.style.display = 'none';
            audioPlayerContainer.style.display = 'none';
            
            // Simulate progress updates (since we can't get real-time updates from the server)
            let progress = 0;
            const progressStages = [
                'Searching for meditations that match your mood...',
                'Finding high-quality audio sources...',
                'Processing your meditation...',
                'Almost ready...'
            ];
            
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    progressBar.style.width = `${Math.min(progress, 90)}%`;
                    
                    // Update progress stage text
                    if (progress < 25) {
                        progressStage.textContent = progressStages[0];
                    } else if (progress < 50) {
                        progressStage.textContent = progressStages[1];
                    } else if (progress < 75) {
                        progressStage.textContent = progressStages[2];
                    } else {
                        progressStage.textContent = progressStages[3];
                    }
                }
            }, 1000);
            
            // Create fetch request
            fetch('/generate-meditation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    mood: selectedMood,
                    language: selectedLanguage
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                // Clear the progress interval
                clearInterval(progressInterval);
                
                // Set progress to 100%
                progressBar.style.width = '100%';
                progressStage.textContent = 'Your meditation is ready!';
                
                // Display the response message
                responseMessage.textContent = data.message || 'Meditation selection successful';
                if (data.note) {
                    responseNote.textContent = data.note;
                }
                
                // Check if we have YouTube info first
                if (data.source_info && data.source_info.youtube_url) {
                    // Redirect directly to YouTube
                    console.log('Redirecting to YouTube:', data.source_info.youtube_url);
                    window.location.href = data.source_info.youtube_url;
                    return; // Stop execution here since we're redirecting
                }
                
                // Set up audio player with the meditation URL only if we're not redirecting to YouTube
                if (data.audio_url) {
                    // Clear any previous event listeners
                    meditationAudio.oncanplay = null;
                    meditationAudio.onerror = null;
                    
                    // Add audio event listeners
                    meditationAudio.onerror = function(e) {
                        console.error('Audio error:', e);
                        alert('Error loading the meditation audio. Please try a different meditation.');
                    };
                    
                    meditationAudio.oncanplay = function() {
                        console.log('Audio is ready to play');
                    };
                    
                    // Set the source and load the audio
                    const absoluteAudioUrl = new URL(data.audio_url, window.location.origin).href;
                    console.log('Setting absolute audio URLs:', absoluteAudioUrl);
                    meditationSource.src = absoluteAudioUrl;
                    document.getElementById('meditation-source-mp4').src = absoluteAudioUrl;
                    meditationAudio.load(); // Reload the audio element
                    
                    // Set up the play button - remove any existing listeners first
                    const forcePlayButton = document.getElementById('force-play-button');
                    
                    // Remove any existing event listeners by cloning and replacing the button
                    const newPlayButton = forcePlayButton.cloneNode(true);
                    forcePlayButton.parentNode.replaceChild(newPlayButton, forcePlayButton);
                    
                    // Add the event listener to the new button
                    newPlayButton.addEventListener('click', function() {
                        // Visual feedback when clicked
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                        
                        // Make sure the audio element has a valid source
                        if (!meditationAudio.src || meditationAudio.src === window.location.href) {
                            console.error('Audio source is not properly set');
                            // Make sure we use an absolute URL with the current origin
                            const absoluteUrl = new URL(data.audio_url, window.location.origin).href;
                            meditationAudio.src = absoluteUrl;
                            console.log('Setting absolute audio URL:', absoluteUrl);
                            meditationAudio.load();
                        }
                        
                        console.log('Attempting to play audio from:', meditationAudio.src);
                        
                        meditationAudio.play()
                            .then(() => {
                                // Reset button text once playing
                                this.innerHTML = '<i class="fas fa-play"></i> Play Meditation';
                            })
                            .catch(e => {
                                console.error('Play failed:', e);
                                this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Play Error';
                                alert('Unable to play audio. Please check your browser settings or try again.');
                            });
                    });
                    
                    audioPlayerContainer.style.display = 'block';
                }
                
                // Show the response container
                responseContainer.style.display = 'block';
                
                // Reset the button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Find My Meditation';
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
                
                // Scroll to the response
                responseContainer.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Clear the progress interval
                clearInterval(progressInterval);
                
                // Hide progress container
                progressContainer.style.display = 'none';
                
                // Show error message
                alert('Failed to generate meditation. Please try again.');
                
                // Reset the button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Find My Meditation';
            });
        });
    });
</script>
{% endblock %} 